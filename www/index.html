<!DOCTYPE html>
<html>
<head>
    <title>Land Lines - Chrome Experiments</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">

    <meta property="og:url" content="https://lines.chromeexperiments.com/" />
    <meta property="og:title" content="Land Lines" />
    <meta property="og:description" content="Land Lines is an experiment that lets you explore real Google Earth satellite imagery through gesture." />
    <meta property="og:image" content="https://lines.chromeexperiments.com/img/LandLines_v2.jpg" />

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Land Lines">
    <meta name="twitter:description" content="Land Lines is an experiment that lets you explore real Google Earth satellite imagery through gesture.">
    <meta name="twitter:image" content="https://lines.chromeexperiments.com/img/LandLines_v2.jpg">
    
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Land Lines">
    <link rel="apple-touch-icon" sizes="36x36" href="https://storage.googleapis.com/navigator-media-usa/media/connected_line/v2/site/www/img/webapp/LandLines_WebAppIcon_36x36.png">
    <link rel="apple-touch-icon" sizes="48x48" href="https://storage.googleapis.com/navigator-media-usa/media/connected_line/v2/site/www/img/webapp/LandLines_WebAppIcon_48x48.png">
    <link rel="apple-touch-icon" sizes="72x72" href="https://storage.googleapis.com/navigator-media-usa/media/connected_line/v2/site/www/img/webapp/LandLines_WebAppIcon_72x72.png">
    <link rel="apple-touch-icon" sizes="96x96" href="https://storage.googleapis.com/navigator-media-usa/media/connected_line/v2/site/www/img/webapp/LandLines_WebAppIcon_96x96.png">
    <link rel="apple-touch-icon" sizes="144x144" href="https://storage.googleapis.com/navigator-media-usa/media/connected_line/v2/site/www/img/webapp/LandLines_WebAppIcon_144x144.png">
    <link rel="apple-touch-icon" sizes="192x192" href="https://storage.googleapis.com/navigator-media-usa/media/connected_line/v2/site/www/img/webapp/LandLines_WebAppIcon_192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="icon" type="image/png" href="favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="favicon-16x16.png" sizes="16x16" />

    <link href="https://fonts.googleapis.com/css?family=Roboto:300" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:300,400,700" rel="stylesheet">
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-86371440-1', 'auto');
    ga('send', 'pageview');
    </script>
    <style>
    @font-face {
        font-family: 'Alibaba PuHuiTi';
        src: url('/fonts/Alibaba-PuHuiTi-Light.ttf') format('truetype'),
             url('/fonts/Alibaba-PuHuiTi-Light.otf') format('opentype');
        font-weight: 300;
        font-style: normal;
        font-display: swap;
    }

    @font-face {
        font-family: 'Alibaba PuHuiTi';
        src: url('/fonts/Alibaba-PuHuiTi-Regular.ttf') format('truetype'),
             url('/fonts/Alibaba-PuHuiTi-Regular.otf') format('opentype');
        font-weight: 400;
        font-style: normal;
        font-display: swap;
    }

    @font-face {
        font-family: 'Alibaba PuHuiTi';
        src: url('/fonts/Alibaba-PuHuiTi-Medium.ttf') format('truetype'),
             url('/fonts/Alibaba-PuHuiTi-Medium.otf') format('opentype');
        font-weight: 500;
        font-style: normal;
        font-display: swap;
    }

    @font-face {
        font-family: 'Alibaba PuHuiTi';
        src: url('/fonts/Alibaba-PuHuiTi-Bold.ttf') format('truetype'),
             url('/fonts/Alibaba-PuHuiTi-Bold.otf') format('opentype');
        font-weight: 600;
        font-style: normal;
        font-display: swap;
    }

    @font-face {
        font-family: 'Alibaba PuHuiTi';
        src: url('/fonts/Alibaba-PuHuiTi-Heavy.ttf') format('truetype'),
             url('/fonts/Alibaba-PuHuiTi-Heavy.otf') format('opentype');
        font-weight: 700;
        font-style: normal;
        font-display: swap;
    }

    html, body {
        position:fixed;
        top:0;
        left:0;
        right:0;
        bottom:0;
        margin: 0;
        color: white;
    	background-color: black;
    	font-family: 'Roboto Condensed', sans-serif;
        font-weight: 300;
        overflow: hidden;
    }
    
    .logo {
        width: 16%; /* 535/3200 = 16.7% */
        height: 4.9%; /* 105/2136 = 4.9% */
        position: absolute;
        top: 5.1%; /* 109/2136 = 5.1% */
        left: 3.2%; /* 102/3200 = 3.2% */
        z-index: 10;
        transform: scale(1.25);
        transform-origin: top left;
    }
    
    .header-row {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: flex-start;
        width: 100%;
        margin-bottom: 5vh;
    }

    a {
        color: white;
        text-decoration: none;
    }


    ul {
        list-style-type: none;
        margin: 0;
        padding: 0;
        /*background:#f9f9f9;*/
    }

    li {
        float: left;
        padding-left:2px;
        /*padding:5px 5px 10px 5px;*/
    }

    li a {
       /* background-color:#ff9900;*/
        display: block;
        color: white;
        text-align: center;
        padding:10px;
        text-decoration: none;
    }

    li a div {
        /*background-color:#ff0099;*/
        /*padding: 10px;*/
    }

    li a .inactive  {
        color: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        border-color: rgba(255, 255, 255, 0);
        border-bottom: none;
    }

    li a .active  {
        border-bottom: 1px solid;
    }

    li a .inactive:hover  {
        color: rgba(255, 255, 255, 1.0);
    }

    input,
    textarea,
    button,
    select,
    a {
    -webkit-tap-highlight-color: rgba(0,0,0,0);
    }

    /* Change the link color to #111 (black) on hover */
    /*li a .active:hover {
        background-color: #9900ff;
    }*/

    #landing-container {
        position: absolute;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.3);
        z-index: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

     #nav-draw {
        z-index: 5;
        padding-bottom:20px !important;
    }

     #nav-drag {
        z-index: 5;
        padding-bottom:20px !important;
 
    }

    #title-container {
        position: absolute;
        width: 100%;
        text-align: center;
        top: 34%; 
    }
    
    #header {
        width: 58.3%;
        margin: 0 auto;
        font-family: 'Alibaba PuHuiTi', sans-serif;
        font-size: 9.1vw; /* 228/3200 = 7.1% */
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em; /* 5% */
        line-height: 100%;
        margin-bottom: 1.7vh;
        letter-spacing: 0.25vw;
    }
    
    #subtitle {
        font-family: 'Alibaba PuHuiTi', sans-serif;
        font-size: 2.8vw; 
        font-weight: 400;
        letter-spacing: 0.3em; /* 30% */
        line-height: 100%;
        margin-top: 0;
        margin-bottom: 0;
    }

    #error {
        font-size: 16pt;
        color: #f9ff49;
       /* background-color: #000;*/
       /* max-width: 480px;*/
        margin-left: auto;
        margin-right: auto;
        padding-top: 0px;
        padding-bottom: 0px;
        margin-top: -28px;
        margin-bottom: -28px;
        display:none;
    }
    #error a {
        color: #f9ff49;
        text-decoration: underline;
    }
    #video_container {
        width: 100%;
        position: relative;
        display:none;
    }
    #video {
/*        margin-left: 50%;
        left: -240px;
        position: relative;
        width: 480px;*/
        width: 60%;
        min-width: 300px ;
        margin-left: auto;
        margin-right: auto;
    }

    #bg{
        left: 0px;
        right: 0px;
        bottom: 0px;
        top: 0px;
        position: absolute;
        /*background-image: url("http://a4.mzstatic.com/eu/r30/Purple3/v4/3d/57/31/3d573127-31d5-e4a9-9f8e-986c4616d467/icon175x175.jpeg");*/
        pointer-events: none;
        will-change: transform; /* creates a new paint layer */
        z-index: -40;
    }
    
    #desc {
        position: absolute;
        top: 5.2%; /* 105/2136 = 4.9% */
        left: 50%; /* 水平居中 */
        transform: translateX(-50%); /* 精确居中 */
        width: 60%; 
        font-family: 'Alibaba PuHuiTi', sans-serif;
        text-align: center;
        z-index: 10;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .desc-cn {
        font-weight: 500;
        font-size: 1.5vw; 
        line-height: 100%;
        letter-spacing: 0.15em;
        margin-bottom: 1.2vh; /* 添加底部间距 */
        margin-top: 0;
    }
    
    .desc-en {
        font-weight: 400;
        font-size: 1.15vw; 
        line-height: 100%;
        letter-spacing: 0.15em;
        margin-top: 0;
        margin-bottom: 0;
    }

    #app {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        height: 100%;
        font-size: 12pt;
        letter-spacing: 0.5pt;
        text-align: center;
        padding-bottom: 8vh;
    }
    
    .btn-cn {
        font-family: 'Alibaba PuHuiTi', sans-serif;
        font-size: 2.5vw; /* 适当缩小 */
        font-weight: 500;
        display: block;
        letter-spacing: 0.15em;
        margin-bottom: 0.1vh; /* 添加底部间距 */
    }
    
    .btn-en {
        font-family: 'Alibaba PuHuiTi', sans-serif;
        font-size: 1.5vw; /* 适当缩小 */
        font-weight: 400;
        display: block;
        letter-spacing: 0.1em;
    }
    
    .start-button {
        position: absolute;
        top: 70%; /* 1437/2136 = 67.3% */
        left: 50%;
        transform: translateX(-50%);
        width: 29.5%; /* 增加宽度 */
        height: 9.5%; /* 增加高度 */
        border-radius: 120px;
        background-color: rgba(58, 58, 58, 0.6); /* 更浅的背景色 */
        border: 1px solid rgba(255, 255, 255, 1);
        box-shadow: 0px 4px 15px 0px rgba(61, 61, 61, 0.25);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        cursor: pointer;
        transition: background-color 0.3s;
        z-index: 10;
    }
    
    .start-button:hover {
        background-color: rgba(58, 58, 58, 0.8) /* 更浅的悬停背景色 */
    }

    #nav {
        display: none;
        /*position: absolute;
        top: 15px;
        left: 10px;*/
        font-size: 15pt;
        font-weight: bold;
        letter-spacing: 0.75pt;
    }

    .about-video {
        position: relative;
        margin-top: 50px;
        padding-bottom: 56.25%;
        height: 0;
        overflow: hidden;
        max-width: 100%;
    }
    .about-video iframe,
    .about-video object,
    .about-video embed {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }

    #draw-container, #drag-container {
        display: none;
        visibility: hidden;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: none;
    }

    /* 响应式设计 - 标准PC端 */
    @media (min-width: 1366px) and (max-width: 1599px) {
        .logo {
            width: 14%; /* 稍微缩小 */
        }

        #desc {
            left: 50%;
            transform: translateX(-50%);
            width: 45%;
        }
        
        .desc-cn {
            font-size: 1.375vw; /* 1.1vw * 1.25 */
        }
        
        .desc-en {
            font-size: 1.125vw; /* 0.9vw * 1.25 */
        }

        #title-container {
            top: 32%;
        }
        
        #header {
            font-size: 6.2vw;
            margin-bottom: 3.6vh;
        }
        
        #subtitle {
            font-size: 2.8vw;
        }

        .start-button {
            width: 29%;
            height: 10.5%;
            top: 73%;
        }
        
        .btn-cn {
            font-size: 2.15vw;
        }
        
        .btn-en {
            font-size: 1.2vw;
        }
    }

    /* 响应式设计 - 大屏PC端 */
    @media (min-width: 1600px) {
        .logo {
            width: 12.5%; 
        }

        #desc {
            left: 50%;
            transform: translateX(-50%);
            width: 50%;
        }
        
        .desc-cn {
            font-size: 1.4vw;
        }
        
        .desc-en {
            font-size: 1.15vw; 
        }

        #title-container {
            top: 32%;
        }
        
        #header {
            font-size: 5.5vw;
            margin-bottom: 3.2vh;
        }
        
        #subtitle {
            font-size: 2.4vw;
        }

        .start-button {
            width: 25%;
            height: 10.5%;
            top: 73%;
        }
        
        .btn-cn {
            font-size: 2.15vw;
        }
        
        .btn-en {
            font-size: 1.2vw;
        }
    }

    /* 响应式设计 - 平板横屏 */
    @media (min-width: 1024px) and (max-width: 1365px) {
        /* .logo {
            width: 18%; 
        } */
    }


    /* 响应式设计 - PC端 */
    @media screen and (min-width: 1025px) {
        
        
        
    }
    
    /* 响应式设计 - 平板设备（基准设计） */
    @media screen and (min-width: 768px) and (max-width: 1024px) {
        

        /* .btn-cn {
            font-size: 4vw;
        }
        
        .btn-en {
            font-size: 2.5vw;
        }
        
        .start-button {
            width: 60%;
            height: 8%;
            bottom: 30%;
        } */
    }
    
    /* 响应式设计 - 移动设备 */
    @media screen and (max-width: 767px) {
        .logo {
            width: 25%;
            top: 3%;
            left: 3%;
        }
        
        #desc {
            top: 8.5%;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
        }
        
        .desc-cn {
            font-size: 3.375vw; /* 2.7vw * 1.25 */
        }
        
        .desc-en {
            font-size: 2.75vw; /* 2.2vw * 1.25 */
        }
        
        #title-container {
            top: 40%;
        }
        
        #header {
            width: 80%;
            font-size: 10vw;
        }
        
        #subtitle {
            font-size: 4vw;
        }
        
        .btn-cn {
            font-size: 4vw;
        }
        
        .btn-en {
            font-size: 2.5vw;
        }
        
        .start-button {
            width: 50%;
            height: 6%;
            bottom: 30%;
        }
    }

    </style>
</head>

<body>

   
    <canvas id="bg">Your browser doesn't support canvas</canvas>
    <div id="landing-container">
       
        <div id="app">
            <div class="header-row">
                <div class="logo">
                    <img src="/img/home/blue_up_logo.png" alt="Logo" width="100%">
                </div>
                <div id="desc">
                    <p class="desc-cn">画一条线，找一片海洋，创造你与大海的故事</p>
                    <p class="desc-en">Draw a line, find a coastline, and create your story with the sea.</p>
                </div>
            </div>
            <div id="title-container">
                <p id="header">LINE - UP</p>
                <p id="subtitle">共绘海岸线</p>
            </div>
            <a class="start-button" href="javascript:void(0)" id="button-start">
                <span class="btn-cn">开始体验</span>
                <span class="btn-en">START NOW</span>
            </a>
            <p id="error"></p>
            <div id="video_container"><div id="video"></div></div>
        </div>

    </div>

    <iframe id="draw-container"></iframe>
    <iframe id="drag-container"></iframe>

    <div id="nav">
        <ul>
            <li><a href="javascript:void(0)" id="nav-draw"><div id="nav-draw-inner">Draw</div></a></li>
            <li><span class="spacer">|</span></li>
            <li><a href="javascript:void(0)" id="nav-drag"><div id="nav-drag-inner">Drag</div></a></li>
        </ul>
    </div>

    <script src="/js/third_party/dat.gui.min.js"></script>
    <script src="/draw/js/Utils.js"></script>
    <script>

    /*
    * Licensed under the Apache License, Version 2.0 (the "License");
    * you may not use this file except in compliance with the License.
    * You may obtain a copy of the License at
    * 
    *     http://www.apache.org/licenses/LICENSE-2.0
    * 
    * Unless required by applicable law or agreed to in writing, software
    * distributed under the License is distributed on an "AS IS" BASIS,
    * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    * See the License for the specific language governing permissions and
    * limitations under the License.
    */
    
    var activeApp = '';

    var gui;
    var animatingElements = [];

    var Gui = function() {
        this.bgOverlay = 0.25;
        this.motionSmooth = 0.1;
        this.mouseXScale = 10;
        this.mouseYScale = 10;
        this.accelGammaDiv = 5;
        this.accelBetaDiv = 3;
    };
    var myGui = new Gui();

    // if user has #dev has, enable dev mode
    var isDevMode = (window.location.hash.indexOf('dev') == -1) ? false : true;

    // if url had #webglError, let's change the display
    var isWebglErrorMode = (window.location.hash.indexOf('webglError') == -1) ? false : true;

    // Do check to see if WebGL is supported
    var canvas = document.createElement("canvas");
    var gl = canvas.getContext("webgl") || canvas.getContext("experimental-webgl");
    // Report the result.
    if (gl && gl instanceof WebGLRenderingContext) {;
    } else {
        isWebglErrorMode = true;
    }


    window.onload = function() {
        
        if (isDevMode) {

            gui = new dat.GUI();
            
            var bgSlider = gui.add(myGui, 'bgOverlay', 0, 1);
            var motionSmoothSlider = gui.add(myGui, 'motionSmooth', 0, 1);
            var mouseXScaleSlider = gui.add(myGui, 'mouseXScale', 0, 100);
            var mouseYScaleSlider = gui.add(myGui, 'mouseYScale', 0, 100);

            var accelGammaDivSlider = gui.add(myGui, 'accelGammaDiv', 0.01, 10.0);
            var accelBetaDivSlider = gui.add(myGui, 'accelBetaDiv', 0.01, 10.0);
       
            bgSlider.onChange(updateBgOpacity);

        }

        if (isWebglErrorMode){
            document.getElementById('button-start').style.display = 'none';

            document.getElementById('video').innerHTML = ' <div class="about-video"><iframe src="https://www.youtube.com/embed/w6-LK9BOVTA?rel=0&amp;controls=1&amp;showinfo=0" frameborder="0" allowfullscreen></iframe></div>';

            document.getElementById('error').innerHTML = 'This experience requires WebGL.<BR>Please try again using a WebGL enabled browser, such as <a href="https://www.google.com/chrome/">Google Chrome</a>';

            document.getElementById('error').style.display = 'block';
            document.getElementById('video_container').style.display = 'block';
        } else {
            document.getElementById('button-start').style.visibility = 'visible';
        }
        
        window.requestAnimationFrame(animate);

    };

    updateBackgroundSize();


    var imageObj = new Image();

    // Load a random background image
    // Store the backgrounds in localStorag as they're used, and use those values
    // to filter out the bgList to only use new ones
    var bgList = ['1006', '1018', '1102', '1240', '1353', '1463', '5586', '6578', '1432', '1495', '1556', '1559', '1567', '1578', '1584', '1617', '1653', '1834', '5425'];
    var filteredList = bgList.slice(0);
    var usedBGs = localStorage.getItem('usedBGs') || '';
    usedBGs = usedBGs.split(',');

    // Remove the empty value from the array that results when you call
    // Array.split() on an empty string
    if (usedBGs.indexOf('') >= 0)
        usedBGs.splice(usedBGs.indexOf(''), 1);

    // Remove used backgrounds to create a filtered list
    for (var i = 0; i < usedBGs.length; i++) {
        if (filteredList.indexOf(usedBGs[i]) >= 0)
            filteredList.splice(filteredList.indexOf(usedBGs[i]), 1);
    }

    // Check if we'v cycled through all of them
    if (filteredList.length == 0) {
        console.log('Used all backgrounds, resetting');
        filteredList = bgList;
        usedBGs = [];
        localStorage.setItem('usedBGs', usedBGs);
    }

    // Finally pull a random image from the filtered list and store it in localStorage
    var bgIndex = Math.floor(Math.random() * filteredList.length);
    var bgFile = 'url("/img/landing/' + filteredList[bgIndex] + '.jpg")';
    usedBGs.push(filteredList[bgIndex]);
    localStorage.setItem('usedBGs', usedBGs.join(','));
    

    var canvas = document.getElementById('bg');
    var context = canvas.getContext('2d');
    imageObj.onload = function() {
        // 初始绘制图像到Canvas
        var canvas = document.getElementById('bg');
        var context = canvas.getContext('2d');
        
        // 确保Canvas尺寸正确
        if (context.canvas.width !== window.innerWidth ||
            context.canvas.height !== window.innerHeight) {
            context.canvas.width = window.innerWidth;
            context.canvas.height = window.innerHeight;
        }
        
        // 计算初始绘制参数
        var scalew = context.canvas.width / imageObj.width;
        var scaleh = context.canvas.height / imageObj.height;
        var maxScale = Math.max(scalew, scaleh);
        
        var w = maxScale * imageObj.width * 1.25; // 稍微放大以覆盖整个Canvas
        var h = maxScale * imageObj.height * 1.25;
        var midX = context.canvas.width / 2;
        var midY = context.canvas.height / 2;
        
        // 绘制图像
        context.drawImage(imageObj, -w/2 + midX, -h/2 + midY, w, h);
    };
    imageObj.src = "/img/landing/" + filteredList[bgIndex] + ".jpg";
    // document.getElementById('app').style.backgroundImage = bgFile;
    //document.getElementById('bg').style.backgroundImage = bgFile;

    function show(elem) {
        elem.style.opacity = 0;
        elem.style.display = 'block';
        elem.targetOpacity = 1;
        animatingElements.push(elem);
        
        /*
        var timer = setInterval(function() {
            if (elem.style.opacity >= 1) {
                elem.style.opacity = 1;
                clearInterval(timer);
                return;
            }

            elem.style.opacity = parseFloat(elem.style.opacity) + 0.07;
        }, 1000 / 60);
        */
    }

    function hide(elem) {
        elem.style.opacity = 1;
        elem.targetOpacity = 0;
        animatingElements.push(elem);
        
        /*
        var timer = setInterval(function() {
            if (elem.style.opacity <= 0) {
                elem.style.opacity = 0;
                elem.style.display = 'none';
                clearInterval(timer);
                return;
            }

            elem.style.opacity = parseFloat(elem.style.opacity) - 0.07;
        }, 1000 / 60);
        */
    }

    function loadApp() {
        var nav = document.getElementById('nav');
        hide(nav);
        
        // 保留header-row元素，只隐藏landing-container中的其他元素
        var headerRow = document.querySelector('.header-row');
        var landingContainer = document.getElementById('landing-container');
        
        // 将header-row移动到body直接子元素，避免被隐藏
        if (headerRow && landingContainer) {
            document.body.appendChild(headerRow);
        }
        
        hide(landingContainer);
        hide(document.getElementById('bg'));

        if (gui) {
            gui.destroy();
            gui = null;
        }
    }

    function loadAppDraw() {
        // Skip if this app is already active
        if (activeApp == 'draw') return;
        activeApp = 'draw';

        loadApp();

        var draw = document.getElementById('draw-container');
        var drag = document.getElementById('drag-container');
        
        hide(drag);
        show(draw);
        drag.src = '';
        setTimeout(function(){ draw.src = '/draw' + window.location.hash; }, 250);

        draw.onload = function() {
            draw.style.visibility = 'visible';
        }

        document.getElementById('nav-draw-inner').className = 'active';
        document.getElementById('nav-drag-inner').className = 'inactive';
        document.getElementById('nav-draw').className = 'active';
        document.getElementById('nav-drag').className = 'inactive';
    }

    function loadAppDrag() {
        // Skip if this app is already active
        if (activeApp == 'drag') return;
        activeApp = 'drag';

        loadApp();
        
        var draw = document.getElementById('draw-container');
        var drag = document.getElementById('drag-container');
        
        hide(draw);
        show(drag);
        draw.src = '';
        setTimeout(function(){ drag.src = '/drag' + window.location.hash; }, 250);

        draw.onload = function() {
            drag.style.visibility = 'visible';
        }

        document.getElementById('nav-draw-inner').className = 'inactive';
        document.getElementById('nav-drag-inner').className = 'active';
        document.getElementById('nav-draw').className = 'inactive';
        document.getElementById('nav-drag').className = 'active';
    }

    // Layout / background image stuff
    function updateBgOpacity() {
        document.getElementById('app').style.backgroundColor = 'rgba(0, 0, 0, ' + myGui.bgOverlay + ')';
    }

    var posSet = false;
    var xPos = 50;
    var yPos = 50;
    var xPosTarget = 50;
    var yPosTarget = 50;
     
   
    function updateBackgroundMouse(e) {
       
        if (myGui !== 'undefined'){
            //console.log(myGui);

            var pctW = e.clientX / this.offsetWidth;
            pctW -= 0.5;
            pctW *= myGui.mouseXScale;

            var pctH = e.clientY / this.offsetHeight;
            pctH -= 0.5;
            pctH *= myGui.mouseYScale;

            xPosTarget = (50 + pctW);
            yPosTarget = (50 + pctH);
        }

        
        
        //this.style.backgroundPositionX = (50 + pctW) + '%';
        //this.style.backgroundPositionY = (50 + pctH) + '%';
    }
     
    function updateBackgroundAccel(e) {
        // var elem = document.getElementById('app');
        // var elem = document.getElementById('landing-container');
        // elem.style.backgroundPositionX = (50 + (e.gamma/1.5)) + '%';
        // elem.style.backgroundPositionY = (50 + (e.beta/2)) + '%';

        if (myGui !== 'undefined'){
            xPosTarget = (50 + 2*(e.gamma/myGui.accelGammaDiv));
            yPosTarget = (50 + -(e.beta/myGui.accelBetaDiv));
        }

    }

    //var container
    var lastX = 0;
    var lastY = 0;
    var lastTime = 0;
    var alpha = 0;

    function animate(timestamp) {

        //


       // console.log(document.getElementById('bg'));
       

        //console.log("animate " + 1000.0 / (timestamp-lastTime));

        lastTime = timestamp;
        //console.log(this.style);
        if (myGui !== 'undefined'){
            xPos = (1-myGui.motionSmooth) * xPos + myGui.motionSmooth * xPosTarget;
            yPos = (1-myGui.motionSmooth) * yPos + myGui.motionSmooth * yPosTarget;
        }

        for (var i = animatingElements.length-1; i >= 0; i--) {
            var elem = animatingElements[i];
            var opacity = Utils.lerp(elem.style.opacity, elem.targetOpacity, 0.18);
            
            elem.style.opacity = opacity;

            if (Math.abs(elem.style.opacity - elem.targetOpacity) <= 0.01) {
                if (elem.targetOpacity == 0) {
                    elem.style.display = 'none';
                }
                animatingElements.splice(i, 1);
            }
        }
        
        
        var canvas = document.getElementById('bg');
        
        // if the BG hasn't faded out
        if (canvas.style.display !== 'none'){
            // if the apps or about page aren't on screen
            if (document.getElementById('draw-container').style.display === 'none' &&
                document.getElementById('drag-container').style.display === 'none'
                ){
                
                var context = canvas.getContext('2d');
                
                // 确保Canvas尺寸正确
                if (context.canvas.width !== window.innerWidth ||
                    context.canvas.height !== window.innerHeight){
                    context.canvas.width = window.innerWidth;
                    context.canvas.height = window.innerHeight;
                }
                
                // 检查图像是否已加载
                if (imageObj.complete && imageObj.naturalWidth !== 0) {
                    var scalew = context.canvas.width / imageObj.width;
                    var scaleh = context.canvas.height / imageObj.height;
                    var maxScale = Math.max(scalew, scaleh);
                   
                    var midX = context.canvas.width * (1.0 - (xPos/100));
                    var midY = context.canvas.height * (1.0 - (yPos/100));
                    
                    var yscale = 1.0 + Math.abs(1.0 - midY/(context.canvas.height*0.5));
                    var xscale = 1.0 + Math.abs(1.0 - midX/(context.canvas.width*0.5));
                    var scale = Math.max(Math.max(yscale, xscale), 1.25);
                    var w = maxScale * imageObj.width * scale;
                    var h = maxScale * imageObj.height * scale;
                    
                    alpha = 0.9 * alpha + 0.1 * 1.0;
                    
                    // 清除Canvas并绘制图像
                    context.fillStyle = "black";
                    context.clearRect(0, 0, canvas.width, canvas.height);
                    
                    if (alpha < 0.99){
                        context.globalAlpha = alpha;
                    } else {
                        context.globalAlpha = 1.0;
                    }
                    
                    // 强制绘制图像
                    try {
                        context.drawImage(imageObj, -w/2 + midX, -h/2 + midY, w, h);
                    } catch(e) {
                        console.error("Error drawing image:", e);
                        // 尝试使用备用方法绘制
                        var fallbackScale = 1.25;
                        var fw = context.canvas.width * fallbackScale;
                        var fh = context.canvas.height * fallbackScale;
                        var fmidX = context.canvas.width / 2;
                        var fmidY = context.canvas.height / 2;
                        context.drawImage(imageObj, -fw/2 + fmidX, -fh/2 + fmidY, fw, fh);
                    }
                } else {
                    console.log("Image not fully loaded yet");
                }
            }
        }

        window.requestAnimationFrame(animate);
  
    }

    function updateBackgroundSize() {
        // twitter ios fix
        // http://stackoverflow.com/questions/27379581/web-page-not-getting-100-height-in-twitter-app-on-ios-8
        document.querySelector("html").style.height = window.innerHeight + "px" 

        var canvas = document.getElementById('bg');       
        var context = canvas.getContext('2d');

        // 确保Canvas尺寸正确
        if (context.canvas.width !== window.innerWidth ||
            context.canvas.height !== window.innerHeight){
             context.canvas.width = window.innerWidth;
             context.canvas.height = window.innerHeight;
        }
        
        // 如果图像已加载，重新绘制
        if (typeof(imageObj) !== 'undefined' && imageObj.complete && imageObj.naturalWidth !== 0){
            var scalew = context.canvas.width / imageObj.width;
            var scaleh = context.canvas.height / imageObj.height;
            var maxScale = Math.max(scalew, scaleh);

            var w = maxScale * imageObj.width * 1.25; // 增加比例确保覆盖
            var h = maxScale * imageObj.height * 1.25;
            var midX = context.canvas.width / 2;
            var midY = context.canvas.height / 2;
            
            context.fillStyle = "black";
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.globalAlpha = 1.0;
            context.drawImage(imageObj, -w/2 + midX, -h/2 + midY, w, h);
        }
    }
    
    document.getElementById('draw-container').style.display = 'none';
    document.getElementById('drag-container').style.display = 'none';

    document.getElementById('button-start').onclick = loadAppDraw;
    document.getElementById('nav-draw').onclick = loadAppDraw;
    document.getElementById('nav-drag').onclick = loadAppDrag;

    // document.getElementById('app').onmousemove = updateBackgroundMouse;
    document.getElementById('landing-container').onmousemove = updateBackgroundMouse;
    window.addEventListener('resize', updateBackgroundSize, false);
    window.addEventListener('deviceorientation', updateBackgroundAccel, false);
    </script>
</body>

</html>
