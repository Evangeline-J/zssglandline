<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>海岸线 - 扫描结果</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:300,400,700" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: transparent;
            color: white;
            font-family: 'Alibaba PuHuiTi', sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .image-container {
            width: auto;
            height: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background-color: transparent;
        }
        
        .matched-image {
            width: 100%;
            height: auto;
            object-fit: contain;
            border: none;
            box-shadow: none;
        }
        
        .image-logo {
            width: 25%;
            position: absolute;
            left: 5%;
            bottom: 5%;
            z-index: 3;
        }
        
        .image-coords {
            position: absolute;
            right: 5%;
            bottom: 5%;
            color: white;
            font-size: 2vw;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
            z-index: 3;
        }
        
    </style>
</head>
<body>
    <div class="image-container">
        <img id="matched-image" class="matched-image" alt="Matched Coastline">
        <img id="logo-image" class="image-logo" alt="Logo">
        <div id="image-coords" class="image-coords"></div>
    </div>
    
    <script>
        // 使用Canvas合成图片并下载
        function composeAndDownloadImage(mainImgSrc, logoImgSrc, coordsText) {
            // 创建一个隐藏的canvas元素
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // 加载主图片
            const mainImg = new Image();
            mainImg.crossOrigin = 'anonymous'; // 允许跨域加载图片
            
            mainImg.onload = function() {
                // 设置canvas尺寸为图片尺寸
                canvas.width = mainImg.width;
                canvas.height = mainImg.height;
                
                // 绘制主图片
                ctx.drawImage(mainImg, 0, 0, canvas.width, canvas.height);
                
                // 加载logo图片
                const logoImg = new Image();
                logoImg.crossOrigin = 'anonymous';
                
                logoImg.onload = function() {
                    // 计算logo位置（左下角）
                    const logoWidth = canvas.width * 0.25; // logo宽度为canvas宽度的25%
                    const logoHeight = logoWidth * (logoImg.height / logoImg.width); // 保持宽高比
                    const logoX = canvas.width * 0.05; // 左边距为canvas宽度的5%
                    const logoY = canvas.height - logoHeight - canvas.height * 0.05; // 底部边距为canvas高度的5%
                    
                    // 绘制logo
                    ctx.drawImage(logoImg, logoX, logoY, logoWidth, logoHeight);
                    
                    // 绘制坐标文本
                    ctx.font = `bold ${canvas.width * 0.04}px 'Alibaba PuHuiTi', sans-serif`;
                    ctx.fillStyle = 'white';
                    ctx.textAlign = 'right';
                    ctx.textBaseline = 'bottom';
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
                    ctx.shadowBlur = 3;
                    ctx.shadowOffsetX = 1;
                    ctx.shadowOffsetY = 1;
                    
                    // 计算文本位置（右下角）
                    const textX = canvas.width - canvas.width * 0.05; // 右边距为canvas宽度的5%
                    const textY = canvas.height - canvas.height * 0.05; // 底部边距为canvas高度的5%
                    
                    // 绘制坐标文本
                    ctx.fillText(coordsText, textX, textY);
                    
                    // 将canvas转换为图片URL
                    const composedImageUrl = canvas.toDataURL('image/jpeg', 0.9);
                    
                    // 创建一个下载链接
                    const downloadLink = document.createElement('a');
                    downloadLink.href = composedImageUrl;
                    downloadLink.download = 'coastline-' + coordsText.replace(/[^\w\s]/gi, '') + '.jpg'; // 文件名
                    
                    // 自动触发下载
                    downloadLink.click();
                };
                
                logoImg.src = logoImgSrc;
            };
            
            mainImg.src = mainImgSrc;
        }
        
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 从URL参数中获取数据
            const urlParams = new URLSearchParams(window.location.search);
            const imageUrl = urlParams.get('img');
            const logoUrl = urlParams.get('logo');
            const coords = urlParams.get('coords');
            
            // 解码URL参数
            const decodedImageUrl = imageUrl ? decodeURIComponent(imageUrl) : '';
            const decodedLogoUrl = logoUrl ? decodeURIComponent(logoUrl) : '';
            const decodedCoords = coords ? decodeURIComponent(coords) : '';
            
            // 设置图片、logo和坐标
            if (decodedImageUrl) document.getElementById('matched-image').src = decodedImageUrl;
            if (decodedLogoUrl) document.getElementById('logo-image').src = decodedLogoUrl;
            if (decodedCoords) document.getElementById('image-coords').textContent = decodedCoords;
            
            // 检查是否所有资源都已加载
            window.addEventListener('load', function() {
                // 延迟一小段时间确保图片已完全加载
                setTimeout(function() {
                    // 合成并下载图片
                    if (decodedImageUrl && decodedLogoUrl && decodedCoords) {
                        composeAndDownloadImage(decodedImageUrl, decodedLogoUrl, decodedCoords);
                    }
                }, 1000);
            });
        });
    </script>
</body>
</html>
